name: nf-test

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java (Nextflow needs Java)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/nextflow
          nextflow -version

      - name: Cache nf-test
        uses: actions/cache@v4
        with:
          path: ~/.cache/nf-test
          key: nf-test-${{ runner.os }}-v1

      - name: Install nf-test (OS/arch-aware)
        shell: bash
        run: |
          set -euo pipefail
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"      # linux or darwin
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64|amd64) ARCH="x86_64" ;;
            aarch64|arm64) ARCH="aarch64" ;;
            *) echo "Unsupported arch: $ARCH" >&2; exit 1 ;;
          esac

          ASSET="nf-test-${OS}-${ARCH}"
          URL="https://github.com/nf-core/nf-test/releases/latest/download/${ASSET}"

          echo "Downloading ${URL}"
          curl -fL "$URL" -o nf-test
          chmod +x nf-test
          sudo mv nf-test /usr/local/bin/nf-test
          /usr/local/bin/nf-test --version
          
      - name: Find test files
        id: discover
        shell: bash
        run: |
          # list *.test files under modules/**/tests/
          mapfile -t TESTS < <(git ls-files 'modules/**/tests/*.test' | sort)
          echo "Found ${#TESTS[@]} test files"
          printf '%s\n' "${TESTS[@]}" > .tests.txt
          # Build a newline-separated list for summary, and a JSON array for matrix
          jq -R -s -c 'split("\n") | map(select(length>0))' .tests.txt > .tests.json
          echo "matrix=$(cat .tests.json)" >> "$GITHUB_OUTPUT"

      - name: Run nf-test (all discovered tests)
        if: ${{ steps.discover.outputs.matrix != '[]' }}
        run: |
          # You can pass extra nf-test flags here if needed
          nf-test test $(cat .tests.txt)

      - name: Job summary
        if: always()
        run: |
          echo "## nf-test summary" >> $GITHUB_STEP_SUMMARY
          if [ -s .tests.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test file |" >> $GITHUB_STEP_SUMMARY
            echo "|---|" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r t; do
              echo "| \`$t\` |" >> $GITHUB_STEP_SUMMARY
            done < .tests.txt
          else
            echo "No nf-test files found." >> $GITHUB_STEP_SUMMARY
          fi
